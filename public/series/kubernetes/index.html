<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>kubernetes | OldTyT</title>
<meta name="keywords" content="">
<meta name="description" content="Personal website OldTyT">
<meta name="author" content="OldTyT">
<link rel="canonical" href="https://oldtyt.xyz/series/kubernetes/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.7140587df96a2b1a49eb723fa7063dc0c641a6cb638f3140e8d3beb4deae4f5c.css" integrity="sha256-cUBYfflqKxpJ63I/pwY9wMZBpstjjzFA6NO&#43;tN6uT1w=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://upload.wikimedia.org/wikipedia/en/9/9a/Trollface_non-free.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://oldtyt.xyz/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://oldtyt.xyz/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://oldtyt.xyz/apple-touch-icon.png">
<link rel="mask-icon" href="https://oldtyt.xyz/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" type="application/rss+xml" href="https://oldtyt.xyz/series/kubernetes/index.xml">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();
    for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
    k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
 
    ym(93497051, "init", {
         clickmap:true,
         trackLinks:true,
         accurateTrackBounce:true
    });
 </script>
 <noscript><div><img src="https://mc.yandex.ru/watch/93497051" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
 
 
 
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2Q1PY6PFPY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2Q1PY6PFPY');
</script>
<meta property="og:title" content="kubernetes" />
<meta property="og:description" content="Personal website OldTyT" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://oldtyt.xyz/series/kubernetes/" /><meta property="og:image" content="https://oldtyt.xyz/papermod-cover.png"/>

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://oldtyt.xyz/papermod-cover.png"/>

<meta name="twitter:title" content="kubernetes"/>
<meta name="twitter:description" content="Personal website OldTyT"/>

</head>

<body class="list" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://oldtyt.xyz/" accesskey="h" title="OldTyT (Alt + H)">OldTyT</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://oldtyt.xyz/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://oldtyt.xyz/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://oldtyt.xyz/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://oldtyt.xyz/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main"> 
<header class="page-header"><div class="breadcrumbs"><a href="https://oldtyt.xyz/">Home</a>&nbsp;»&nbsp;<a href="https://oldtyt.xyz/series/">Series</a></div>
  <h1>
    kubernetes
    <a href="/series/kubernetes/index.xml" title="RSS" aria-label="RSS">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" height="23">
        <path d="M4 11a9 9 0 0 1 9 9" />
        <path d="M4 4a16 16 0 0 1 16 16" />
        <circle cx="5" cy="19" r="1" />
      </svg>
    </a>
  </h1>
</header>

<article class="post-entry tag-entry"> 
  <header class="entry-header">
    <h2>How I launched minecraft in kubernetes
    </h2>
  </header>
  <div class="entry-content">
    <p>Minecraft in kubernetes Hello everyone, in this article I will share with you my experience in launching minecraft in kubernetes.
The main problem that arises when trying to launch minecraft in kubernetes is that while minecraft is running, files are being worked on on the local disk, and this approach in kubernetes is anti-pathetic, since in case of failure of the node (let’s call it node A) on which the pod was deployed - pod will not be able to be created on another node (node B), since it is known that pod previously worked on node A and, accordingly, all its permanent files are there.
Options for solving problems with the use of permanent files While searching for a solution to this problem, I identified the following solutions for myself:
 rejection of permanent files use native Persistent Volume create a network drive use csi-s3  Let’s take a closer look at each of the options
Abandoning permanent files Positive:
 The best solution for applications in kubernetes  Minuses:
 Not applicable to the current application  Use Native Persistent Volume Positive:
 High speed of reading/writing files  Minuses:
 All data is on the same node, in case of its breakdown, the pod will not be able to rise  Create a network drive Positive:
 The data is replicated to multiple nodes  Minuses:
 Low file read/write speed  Use csi-s3 Positive:
 The data was taken out from the cluster  Minuses:
 Low file read/write speed An extremely high price may come out due to the large number of API calls  Analysis of options Based on the data obtained, we come to the conclusion that at the moment, there is no solution that could meet our requirements, namely:
 high speed of reading / writing files there must be no binding to a specific node it should be done as budget-friendly as possible  Solving the problem using persistent data To solve this problem, was prepared docker container.
The algorithm of the container  SSH keys are being added. The keys are taken from the values of the ENV variables. The repository is cloned from github with the server configuration to the directory - /app The sequences MYSQL_.&#43; are replaced in all files in /app/plugins by their value. The game world is being copied from s3 storage and unpacked Game plugins and kernel are being copied from s3 storage Starts /task_manager.py  - which is responsible for the execution of cron tasks, the operation of the server and the output of syslog  Cron tasks In cron tasks, the following tasks are currently configured:
* * * * * root /git_pull.sh | logger * * * * * root /git_commit.sh | logger 0 * * * * root /copy_worlds.sh | logger Learn more about each task:
 /git_pull.sh - executes git pull in the /app directory /git_commit.sh  - creates a commit and pushes it to the repository /copy_worlds.sh - makes a copy of the world and uploads it to s3 storage in place of the existing one  Example of service deployment Setting up the ingress controller Consider the example of traffic&#39;. To configure the ingress` controller, you will need to run the following command:
$ helm upgrade --values traefik-values.yaml traefik traefik/traefik -n kube-system Contents of the traefik-values.yaml file:
ports:traefik:port:9000expose:falseexposedPort:9000protocol:TCPweb:port:8000expose:trueexposedPort:80protocol:TCPminecraft:port:22565expose:trueexposedPort:25565protocol:TCPwebsecure:port:8443expose:trueexposedPort:443protocol:TCPhttp3:enabled:falsetls:enabled:trueoptions:&#34;&#34;certResolver:&#34;&#34;domains:[]middlewares:[]metrics:port:9100expose:falseexposedPort:9100protocol:TCPAfter that, connections to LoadBalancer will be allowed on port 25565:
$ kubectl get svc -n kube-system | grep -v &#34;none&#34; NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE traefik LoadBalancer 10.43.2.50 100.10.0.11 25565:30224/TCP,80:31380/TCP,443:30226/TCP 2d21h Deploy Example of the final manifest that contains the required configuration:
---apiVersion:v1kind:Namespacemetadata:name:minecraft---apiVersion:v1kind:Secretmetadata:name:minecraft-secretnamespace:minecrafttype:Opaquedata:SSH_KEY_PUBLIC:&#34;SECRET&#34;SSH_KEY_PRIVATE:&#34;SECRET&#34;MYSQL_ROOT_PASSWORD:&#34;SECRET&#34;MYSQL_DBS:&#34;SECRET&#34;MYSQL_HOST:&#34;SECRET&#34;MYSQL_USER:&#34;SECRET&#34;MYSQL_PASSWORD:&#34;SECRET&#34;S3_BUCKET:&#34;SECRET&#34;S3_ACCESS_KEY:&#34;SECRET&#34;S3_ACCESS_KEY_ID:&#34;SECRET&#34;---apiVersion:apps/v1kind:Deploymentmetadata:name:some_worlds_namenamespace:minecraftspec:selector:matchLabels:app:some_worlds_namestrategy:type:Recreatetemplate:metadata:namespace:minecraftlabels:app:some_worlds_namespec:imagePullSecrets:- name:github-registrycontainers:- image:ghcr.io/oldtyt/docker_minecraftimagePullPolicy:Alwaysname:some_worlds_nameresources:requests:cpu:1000mmemory:5Glimits:memory:6Gcpu:1200menv:- name:XMXvalue:&#34;5G&#34;- name:&#34;XMS&#34;value:&#34;512M&#34;- name:MYSQL_HOSTvalueFrom:secretKeyRef:name:minecraft-secretkey:MYSQL_HOST- name:MYSQL_USERvalueFrom:secretKeyRef:name:minecraft-secretkey:MYSQL_USER- name:MYSQL_DBvalueFrom:secretKeyRef:name:minecraft-secretkey:MYSQL_USER- name:MYSQL_PASSWORDvalueFrom:secretKeyRef:name:minecraft-secretkey:MYSQL_PASSWORD- name:S3_BUCKETvalueFrom:secretKeyRef:name:minecraft-secretkey:S3_BUCKET- name:S3_ACCESS_KEYvalueFrom:secretKeyRef:name:minecraft-secretkey:S3_ACCESS_KEY- name:S3_ACCESS_KEY_IDvalueFrom:secretKeyRef:name:minecraft-secretkey:S3_ACCESS_KEY_ID- name:SSH_KEY_PRIVATEvalueFrom:secretKeyRef:name:minecraft-secretkey:SSH_KEY_PRIVATE- name:SSH_KEY_PUBLICvalueFrom:secretKeyRef:name:minecraft-secretkey:SSH_KEY_PUBLIC- name:PLUGINS_LISTvalue:&#34;some,plugins,list&#34;- name:GIT_REPOvalue:&#34;git@github.com:USER/REPO.git&#34;- name:KERNELvalue:&#34;KERNEL&#34;- name:&#34;WORLDS&#34;value:&#34;some_worlds_name&#34;---apiVersion:v1kind:Servicemetadata:name:some_worlds_namenamespace:minecraftlabels:env:prodapp:some_worlds_nameowner:OldTyTspec:ports:- name:minecrafttargetPort:25565port:25565protocol:TCPselector:app:some_worlds_nameThe command to deploy the manifest:
$ kubectl apply -f minecraft.yaml </p>
  </div>
  <footer class="entry-footer"><span title='2023-06-05 00:00:00 +0000 UTC'>June 5, 2023</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;OldTyT</footer>
  <a class="entry-link" aria-label="post link to How I launched minecraft in kubernetes" href="https://oldtyt.xyz/posts/minecraft_in_kubernetes/"></a>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://oldtyt.xyz/">OldTyT</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
